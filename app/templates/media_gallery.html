{% extends "base.html" %} {% block title %}Media Gallery - Community Platform{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-images"></i> Media Gallery</h2>
  {% if current_user.is_authenticated %}
  <a href="{{ url_for('main.upload_media') }}" class="btn btn-primary">
    <i class="fas fa-upload"></i> Upload Media
  </a>
  {% endif %}
</div>

<!-- Filter Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a
      class="nav-link {{ 'active' if current_filter == 'all' else '' }}"
      href="{{ url_for('main.media_gallery', filter='all') }}"
    >
      <i class="fas fa-th"></i> All Media
    </a>
  </li>
  <li class="nav-item">
    <a
      class="nav-link {{ 'active' if current_filter == 'image' else '' }}"
      href="{{ url_for('main.media_gallery', filter='image') }}"
    >
      <i class="fas fa-image"></i> Images
    </a>
  </li>
  <li class="nav-item">
    <a
      class="nav-link {{ 'active' if current_filter == 'video' else '' }}"
      href="{{ url_for('main.media_gallery', filter='video') }}"
    >
      <i class="fas fa-video"></i> Videos
    </a>
  </li>
  <li class="nav-item">
    <a
      class="nav-link {{ 'active' if current_filter == 'document' else '' }}"
      href="{{ url_for('main.media_gallery', filter='document') }}"
    >
      <i class="fas fa-file"></i> Documents
    </a>
  </li>
</ul>

<!-- Media Grid -->
{% if media_files.items %}
<div class="row g-3">
  {% for media in media_files.items %}
  <div class="col-md-6 col-lg-4 col-xl-3">
    <div class="card h-100 media-card" data-media-id="{{ media.id }}">
      <div class="position-relative">
        {% if media.is_image() %}
        <img
          src="{{ media.get_url() }}"
          class="card-img-top"
          alt="{{ media.description or media.original_filename }}"
          style="height: 200px; object-fit: cover; cursor: pointer"
          onclick="openMediaModal({{ media.id }})"
        />
        {% elif media.is_video() %}
        <div
          class="bg-dark d-flex align-items-center justify-content-center"
          style="height: 200px; cursor: pointer"
          onclick="openMediaModal({{ media.id }})"
        >
          <i class="fas fa-play fa-3x text-white"></i>
        </div>
        {% else %}
        <div
          class="bg-secondary d-flex align-items-center justify-content-center"
          style="height: 200px; cursor: pointer"
          onclick="openMediaModal({{ media.id }})"
        >
          <i class="fas fa-file fa-3x text-white"></i>
        </div>
        {% endif %}

        <!-- File Type Badge -->
        <span class="position-absolute top-0 end-0 m-2 badge bg-dark">
          {{ media.file_type.upper() }}
        </span>

        <!-- Actions Dropdown -->
        {% if current_user.is_authenticated and (current_user.id ==
        media.user_id or current_user.is_admin) %}
        <div class="position-absolute top-0 start-0 m-2">
          <div class="dropdown">
            <button
              class="btn btn-sm btn-dark dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="{{ media.get_url() }}" download>
                  <i class="fas fa-download"></i> Download
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a
                  class="dropdown-item text-danger"
                  href="#"
                  onclick="deleteMedia({{ media.id }})"
                >
                  <i class="fas fa-trash"></i> Delete
                </a>
              </li>
            </ul>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card-body">
        <h6
          class="card-title text-truncate"
          title="{{ media.original_filename }}"
        >
          {{ media.original_filename }}
        </h6>

        {% if media.description %}
        <p class="card-text small text-muted">{{ media.description }}</p>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="fas fa-user"></i>
            <a
              href="{{ url_for('main.user_profile', username=media.uploader.username) }}"
              class="text-decoration-none"
              >{{ media.uploader.first_name }}</a
            >
          </small>
          <small class="text-muted">
            {{ (media.file_size / (1024 * 1024))|round(1) }} MB
          </small>
        </div>

        <small class="text-muted d-block mt-1">
          <i class="fas fa-clock"></i> {{ media.created_at.strftime('%b %d, %Y')
          }}
        </small>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if media_files.pages > 1 %}
<nav aria-label="Media pagination" class="mt-4">
  <ul class="pagination justify-content-center">
    {% if media_files.has_prev %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('main.media_gallery', page=media_files.prev_num, filter=current_filter) }}"
      >
        <i class="fas fa-chevron-left"></i> Previous
      </a>
    </li>
    {% endif %} {% for page_num in range(1, media_files.pages + 1) %} {% if
    page_num == media_files.page %}
    <li class="page-item active">
      <span class="page-link">{{ page_num }}</span>
    </li>
    {% elif page_num <= media_files.page + 2 and page_num >= media_files.page -
    2 %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('main.media_gallery', page=page_num, filter=current_filter) }}"
        >{{ page_num }}</a
      >
    </li>
    {% endif %} {% endfor %} {% if media_files.has_next %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('main.media_gallery', page=media_files.next_num, filter=current_filter) }}"
      >
        Next <i class="fas fa-chevron-right"></i>
      </a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %} {% else %}
<div class="text-center py-5">
  <i class="fas fa-images fa-3x text-muted mb-3"></i>
  <h4 class="text-muted">No media files found</h4>
  <p class="text-muted">
    {% if current_filter == 'all' %} No media has been uploaded yet. {% else %}
    No {{ current_filter }} files found. {% endif %}
  </p>
  {% if current_user.is_authenticated %}
  <a href="{{ url_for('main.upload_media') }}" class="btn btn-primary">
    <i class="fas fa-upload"></i> Upload First File
  </a>
  {% endif %}
</div>
{% endif %}

<!-- Media Modal -->
<div class="modal fade" id="mediaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mediaModalTitle">Media Preview</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body text-center" id="mediaModalBody">
        <!-- Media content will be loaded here -->
      </div>
      <div class="modal-footer">
        <div class="me-auto" id="mediaModalInfo">
          <!-- Media info will be loaded here -->
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <a href="#" class="btn btn-primary" id="mediaModalDownload" download>
          <i class="fas fa-download"></i> Download
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Media data for modal
  const mediaData = {
      {% for media in media_files.items %}
      {{ media.id }}: {
          id: {{ media.id }},
          filename: '{{ media.original_filename }}',
          description: '{{ media.description or '' }}',
          type: '{{ media.file_type }}',
          url: '{{ media.get_url() }}',
          size: '{{ (media.file_size / (1024 * 1024))|round(1) }} MB',
          uploader: '{{ media.uploader.get_full_name() }}',
          uploaded: '{{ media.created_at.strftime('%B %d, %Y at %I:%M %p') }}'
      }{% if not loop.last %},{% endif %}
      {% endfor %}
  };

  function openMediaModal(mediaId) {
      const media = mediaData[mediaId];
      if (!media) return;

      const modal = new bootstrap.Modal(document.getElementById('mediaModal'));
      const title = document.getElementById('mediaModalTitle');
      const body = document.getElementById('mediaModalBody');
      const info = document.getElementById('mediaModalInfo');
      const download = document.getElementById('mediaModalDownload');

      title.textContent = media.filename;
      download.href = media.url;

      // Clear previous content
      body.innerHTML = '';

      // Load media content based on type
      if (media.type === 'image') {
          const img = document.createElement('img');
          img.src = media.url;
          img.className = 'img-fluid';
          img.alt = media.description || media.filename;
          body.appendChild(img);
      } else if (media.type === 'video') {
          const video = document.createElement('video');
          video.src = media.url;
          video.className = 'img-fluid';
          video.controls = true;
          body.appendChild(video);
      } else {
          const fileIcon = document.createElement('div');
          fileIcon.className = 'py-5';
          fileIcon.innerHTML = `
              <i class="fas fa-file fa-5x text-muted mb-3"></i>
              <h5>${media.filename}</h5>
              <p class="text-muted">Click download to view this file</p>
          `;
          body.appendChild(fileIcon);
      }

      // Set media info
      info.innerHTML = `
          <small class="text-muted">
              <strong>Size:</strong> ${media.size}<br>
              <strong>Uploaded by:</strong> ${media.uploader}<br>
              <strong>Date:</strong> ${media.uploaded}
              ${media.description ? `<br><strong>Description:</strong> ${media.description}` : ''}
          </small>
      `;

      modal.show();
  }

  function deleteMedia(mediaId) {
      if (confirm('Are you sure you want to delete this media file?')) {
          fetch(`/media/${mediaId}/delete`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              }
          }).then(response => {
              if (response.ok) {
                  location.reload();
              } else {
                  alert('Failed to delete media file');
              }
          });
      }
  }

  // Lazy loading for images
  document.addEventListener('DOMContentLoaded', function() {
      const images = document.querySelectorAll('img[data-src]');
      const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
              if (entry.isIntersecting) {
                  const img = entry.target;
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                  imageObserver.unobserve(img);
              }
          });
      });

      images.forEach(img => imageObserver.observe(img));
  });
</script>
{% endblock %}
