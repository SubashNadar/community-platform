{% extends "base.html" %} {% block title %}{{ post.title }} - Community
Platform{% endblock %} {% block content %}
<div class="row">
  <div class="col-lg-8">
    <!-- Post Content -->
    <article class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title">{{ post.title }}</h1>

        <div class="d-flex align-items-center mb-3 text-muted">
          {% if post.author.avatar_url %}
          <img
            src="{{ post.author.avatar_url }}"
            class="rounded-circle me-2"
            width="40"
            height="40"
            alt="Avatar"
          />
          {% else %}
          <div
            class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center"
            style="width: 40px; height: 40px"
          >
            <i class="fas fa-user text-white"></i>
          </div>
          {% endif %}
          <div>
            <strong>{{ post.author.get_full_name() }}</strong>
            <br />
            <small>
              <i class="fas fa-calendar"></i> {{ post.created_at.strftime('%B
              %d, %Y at %I:%M %p') }} {% if post.updated_at != post.created_at
              %}
              <span class="text-muted"
                >(Updated: {{ post.updated_at.strftime('%B %d, %Y') }})</span
              >
              {% endif %}
            </small>
          </div>
        </div>

        <div class="mb-3">
          <small class="text-muted">
            <i class="fas fa-eye"></i> {{ post.view_count }} views
            <span class="mx-2">â€¢</span>
            <i class="fas fa-comments"></i> {{ comments.total }} comments
          </small>
        </div>

        <div class="post-content">{{ post.content_html|safe }}</div>

        {% if current_user.is_authenticated and (current_user.id == post.user_id
        or current_user.is_admin) %}
        <div class="mt-4 pt-3 border-top">
          <div class="btn-group" role="group">
            <a
              href="{{ url_for('main.edit_blog', id=post.id) }}"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-edit"></i> Edit
            </a>
            <button
              type="button"
              class="btn btn-outline-danger btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal"
            >
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    </article>

    <!-- Comments Section -->
    <div class="card shadow-sm mt-4">
      <div class="card-header">
        <h5><i class="fas fa-comments"></i> Comments ({{ comments.total }})</h5>
      </div>
      <div class="card-body">
        {% if current_user.is_authenticated %}
        <!-- Add Comment Form -->
        <form
          method="POST"
          action="{{ url_for('main.add_comment', id=post.id) }}"
          class="mb-4"
        >
          <div class="mb-3">
            <label for="content" class="form-label">Add a comment</label>
            <textarea
              class="form-control"
              id="content"
              name="content"
              rows="3"
              placeholder="Share your thoughts..."
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Post Comment
          </button>
        </form>
        <hr />
        {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <a href="{{ url_for('auth.login') }}">Login</a> to post a comment.
        </div>
        {% endif %}

        <!-- Comments List -->
        {% if comments.items %} {% for comment in comments.items %}
        <div class="comment mb-3 pb-3 border-bottom">
          <div class="d-flex">
            {% if comment.author.avatar_url %}
            <img
              src="{{ comment.author.avatar_url }}"
              class="rounded-circle me-3"
              width="40"
              height="40"
              alt="Avatar"
            />
            {% else %}
            <div
              class="bg-secondary rounded-circle me-3 d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px"
            >
              <i class="fas fa-user text-white"></i>
            </div>
            {% endif %}
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ comment.author.get_full_name() }}</strong>
                  <small class="text-muted"
                    >@{{ comment.author.username }}</small
                  >
                  <br />
                  <small class="text-muted">
                    <i class="fas fa-clock"></i> {{
                    comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                  </small>
                </div>
                {% if current_user.is_authenticated and (current_user.id ==
                comment.user_id or current_user.is_admin) %}
                <div class="dropdown">
                  <button
                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                  >
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item text-danger delete-comment-btn"
                        href="#"
                        data-comment-id="{{ comment.id }}"
                      >
                        <i class="fas fa-trash"></i> Delete
                      </a>
                    </li>
                  </ul>
                </div>
                {% endif %}
              </div>
              <div class="mt-2">{{ comment.content_html|safe }}</div>
            </div>
          </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if comments.pages > 1 %}
        <nav aria-label="Comments pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if comments.has_prev %}
            <li class="page-item">
              <a
                class="page-link"
                href="{{ url_for('main.blog_detail', id=post.id, page=comments.prev_num) }}"
              >
                Previous
              </a>
            </li>
            {% endif %} {% for page_num in comments.iter_pages() %} {% if
            page_num %} {% if page_num != comments.page %}
            <li class="page-item">
              <a
                class="page-link"
                href="{{ url_for('main.blog_detail', id=post.id, page=page_num) }}"
              >
                {{ page_num }}
              </a>
            </li>
            {% else %}
            <li class="page-item active">
              <span class="page-link">{{ page_num }}</span>
            </li>
            {% endif %} {% else %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% endif %} {% endfor %} {% if comments.has_next %}
            <li class="page-item">
              <a
                class="page-link"
                href="{{ url_for('main.blog_detail', id=post.id, page=comments.next_num) }}"
              >
                Next
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %} {% else %}
        <p class="text-muted text-center">
          No comments yet. Be the first to comment!
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Author Info -->
    <div class="card shadow-sm">
      <div class="card-header">
        <h6><i class="fas fa-user"></i> About the Author</h6>
      </div>
      <div class="card-body text-center">
        {% if post.author.avatar_url %}
        <img
          src="{{ post.author.avatar_url }}"
          class="rounded-circle mb-3"
          width="80"
          height="80"
          alt="Avatar"
        />
        {% else %}
        <div
          class="bg-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
          style="width: 80px; height: 80px"
        >
          <i class="fas fa-user fa-2x text-white"></i>
        </div>
        {% endif %}
        <h6>{{ post.author.get_full_name() }}</h6>
        <p class="text-muted">@{{ post.author.username }}</p>
        {% if post.author.bio %}
        <p class="small">{{ post.author.bio }}</p>
        {% endif %}
        <a
          href="{{ url_for('main.user_profile', username=post.author.username) }}"
          class="btn btn-outline-primary btn-sm"
        >
          View Profile
        </a>
      </div>
    </div>

    <!-- Post Stats -->
    <div class="card shadow-sm mt-3">
      <div class="card-header">
        <h6><i class="fas fa-chart-bar"></i> Post Statistics</h6>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <h5 class="text-primary">{{ post.view_count }}</h5>
            <small class="text-muted">Views</small>
          </div>
          <div class="col-6">
            <h5 class="text-success">{{ comments.total }}</h5>
            <small class="text-muted">Comments</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Post -->
    <div class="card shadow-sm mt-3">
      <div class="card-header">
        <h6><i class="fas fa-share"></i> Share this Post</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="sharePost()">
            <i class="fas fa-link"></i> Copy Link
          </button>
          <a
            href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.url|urlencode }}"
            target="_blank"
            class="btn btn-outline-info btn-sm"
          >
            <i class="fab fa-twitter"></i> Share on Twitter
          </a>
          <a
            href="https://www.facebook.com/sharer/sharer.php?u={{ request.url|urlencode }}"
            target="_blank"
            class="btn btn-outline-primary btn-sm"
          >
            <i class="fab fa-facebook"></i> Share on Facebook
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Post Modal -->
{% if current_user.is_authenticated and (current_user.id == post.user_id or
current_user.is_admin) %}
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">Delete Post</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this post?</p>
        <p><strong>"{{ post.title }}"</strong></p>
        <p class="text-muted">
          This action cannot be undone. All comments will also be deleted.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <form
          method="POST"
          action="{{ url_for('main.delete_blog', id=post.id) }}"
          class="d-inline"
        >
          <button type="submit" class="btn btn-danger">Delete Post</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  function sharePost() {
    if (navigator.share) {
      navigator.share({
        title: "{{ post.title }}",
        text: "{{ post.summary or post.title }}",
        url: window.location.href,
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href).then(function () {
        alert("Link copied to clipboard!");
      });
    }
  }

  // Handle comment deletion
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".delete-comment-btn").forEach(function (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const commentId = this.getAttribute("data-comment-id");
        deleteComment(commentId);
      });
    });
  });

  function deleteComment(commentId) {
    if (confirm("Are you sure you want to delete this comment?")) {
      fetch(`/comment/${commentId}/delete`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => {
          if (response.ok) {
            location.reload();
          } else {
            alert("Error deleting comment. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Error deleting comment. Please try again.");
        });
    }
  }
</script>
{% endblock %}
